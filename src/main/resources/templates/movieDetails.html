<!DOCTYPE html>
<html lang="pl"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <meta charset="UTF-8">
    <title th:text="${movie.getTitle()}"></title>
    <meta id="_csrf" name="_csrf" th:content="${_csrf.token}"/>
    <meta id="_csrf_header" name="_csrf_header" th:content="${_csrf.headerName}"/>
</head>
<body>
<div th:object="${movie}">
    <div class="poster">
        <img alt="poster could not load" th:src="*{getPoster()}" width="300" height="444">
    </div>
    <span>
            <span th:text="*{title}"></span>
            <span th:text="'('+*{getYear()}+')'"></span>
        </span>
    <div>
        <p th:text="*{plot}"></p>
    </div>
    <div id="rankings">
        <label>
            IMDB rating:
            <span th:text="*{imdbRating}"></span>
        </label>
        <label>
            Filmoteka rating:
            <span th:text="${#numbers.formatDecimal(avgRating,1,2)}"></span>
        </label>
    </div>
    <div id="like">
        <input type="submit" value="Obserwuj" onclick="like()">
    </div>
</div>
<!--/*@thymesVar id="review" type="lipamar.filmoteka.domain.review.Review"*/-->
<form sec:authorize="isAuthenticated()" method="POST" th:action="@{'/movie/'+ ${movie.getImdbID()}}"
      th:object="${review}">
    <div>
        <label>Ocena:</label>
        <input type="number" min="1" max="10" th:field="*{rate}">
    </div>
    <textarea th:field="*{content}"></textarea>

    <input type="submit">
</form>
<div sec:authorize="!isAuthenticated()">
    <p><a th:href="@{/register}">Zarejestruj</a> lub <a th:href="@{/login}">zaloguj</a> się, aby móc dodawać własne
        recenzje!</p>
</div>
<div>
    <ul th:each="comment:${reviews}">
        <li>
            <span th:text="'Ocena: '+*{comment.rate}"></span><br>
            <span th:text="'Data: '+*{#dates.format(comment.date,'dd/MM/yyyy')}"></span><br>
            <span th:text="*{comment.content}"></span><br>
        </li>
    </ul>
</div>
<script th:inline="javascript">
    /*<![CDATA[*/

    function like() {
        let path = /*[[@{'/movie/'+${movie.getImdbID()}+'/like'}]]*/ '';
        let xhttp = new XMLHttpRequest();
        var token = $("meta[name='_csrf']").attr("content");
        var header = $("meta[name='_csrf_header']").attr("content");
        xhttp.onreadystatechange = function (){
            if(this.readyState===4 && this.status===200){
                alert(this.response);
            }
        }
        xhttp.open("POST","http://localhost:8080/movie/tt1273235/like",true);
        xhttp.setRequestHeader("Content-type", "application/json");
        xhttp.setRequestHeader(header, token);
        xhttp.send();
        alert(xhttp.response);
    }

    /*]]>*/
</script>
</body>
</html>